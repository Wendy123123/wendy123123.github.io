<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JS ä¹‹ promise | wendy-banzhuanke</title>
<link rel="shortcut icon" href="https://wendy-banzhuanke.github.io/favicon.ico?v=1603531535211">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://wendy-banzhuanke.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="JS ä¹‹ promise | wendy-banzhuanke - Atom Feed" href="https://wendy-banzhuanke.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="Promiseæ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ¯”ä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆâ€”â€”å›è°ƒå‡½æ•°å’Œäº‹ä»¶â€”â€”æ›´åˆç†ä¸”æ›´å¼ºå¤§ã€‚å®ƒæœ€æ—©ç”±ç¤¾åŒºæå‡ºå¹¶å®ç°ï¼ŒES6å°†å…¶å†™è¿›äº†è¯­è¨€æ ‡å‡†ï¼Œç»Ÿä¸€äº†ç”¨æ³•ï¼Œå¹¶åŸç”Ÿæä¾›äº†Promiseå¯¹è±¡ã€‚
æ‰€è°“Promise,ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢ä¿å­˜..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://wendy-banzhuanke.github.io">
  <img class="avatar" src="https://wendy-banzhuanke.github.io/images/avatar.png?v=1603531535211" alt="">
  </a>
  <h1 class="site-title">
    wendy-banzhuanke
  </h1>
  <p class="site-description">
    æ’¸èµ·è¢–å­åŠ æ²¹å¹²ï¼
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          Home
        </a>
      
    
      
        <a href="/archives" class="menu">
          Archives
        </a>
      
    
      
        <a href="/tags" class="menu">
          Tags
        </a>
      
    
      
        <a href="/about" class="menu">
          About Me
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              JS ä¹‹ promise
            </h2>
            <div class="post-info">
              <span>
                2019-08-03
              </span>
              <span>
                10 min read
              </span>
              
            </div>
            
              <img class="post-feature-image" src="https://wendy-banzhuanke.github.io/post-images/js-file-promise.jpeg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <p>Promiseæ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ¯”ä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆâ€”â€”å›è°ƒå‡½æ•°å’Œäº‹ä»¶â€”â€”æ›´åˆç†ä¸”æ›´å¼ºå¤§ã€‚å®ƒæœ€æ—©ç”±ç¤¾åŒºæå‡ºå¹¶å®ç°ï¼ŒES6å°†å…¶å†™è¿›äº†è¯­è¨€æ ‡å‡†ï¼Œç»Ÿä¸€äº†ç”¨æ³•ï¼Œå¹¶åŸç”Ÿæä¾›äº†Promiseå¯¹è±¡ã€‚</p>
<p>æ‰€è°“Promise,ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢ä¿å­˜ç€æŸä¸ªæœªæ¥æ‰ä¼šç»“æŸçš„äº‹ä»¶çš„ç»“æœã€‚Promiseæä¾›ç»Ÿä¸€çš„API,å„ç§å¼‚æ­¥æ“ä½œéƒ½å¯ä»¥ç”¨åŒæ ·çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ä»å‡ æ–¹é¢æ¥äº†è§£Promiseã€‚</p>
<!-- more -->
<h3 id="1-promisea-è§„èŒƒ">1. Promise/A+ è§„èŒƒ</h3>
<p>åœ¨ç¼–å†™ Promise ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»äº†è§£ Promise/A+ è§„èŒƒã€‚ç”±äºå†…å®¹è¾ƒé•¿ï¼Œä¸‹é¢æˆ‘æ€»ç»“äº†å‡ ç‚¹ï¼Œæ›´è¯¦ç»†çš„å†…å®¹å¯ä»¥æŸ¥é˜… <a href="https://promisesaplus.com/">Promise/A+ è§„èŒƒ</a>ã€‚</p>
<p>Promise æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œå¯¹å¤–æä¾›äº†ä¸€ä¸ª then å‡½æ•°ï¼Œå†…éƒ¨æ‹¥æœ‰ 3 ä¸ªçŠ¶æ€ã€‚</p>
<h4 id="then-å‡½æ•°">then å‡½æ•°</h4>
<p>then å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‡½æ•°ä½œä¸ºå¯é€‰å‚æ•°ï¼š</p>
<pre><code>promise.then(onFulfilled, onRejected)
</code></pre>
<p>åŒæ—¶éµå¾ªä¸‹é¢å‡ ä¸ªè§„åˆ™ï¼š</p>
<ul>
<li>å¦‚æœå¯é€‰å‚æ•°ä¸ä¸ºå‡½æ•°æ—¶åº”è¯¥è¢«å¿½ç•¥ï¼›</li>
<li>ä¸¤ä¸ªå‡½æ•°éƒ½åº”è¯¥æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå³æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ç­‰å¾…ä¸‹ä¸€è½® tickï¼Œè€Œéç«‹å³æ‰§è¡Œï¼›</li>
<li>å½“è°ƒç”¨ onFulfilled å‡½æ•°æ—¶ï¼Œä¼šå°†å½“å‰ Promise çš„å€¼ä½œä¸ºå‚æ•°ä¼ å…¥ï¼›</li>
<li>å½“è°ƒç”¨ onRejected å‡½æ•°æ—¶ï¼Œä¼šå°†å½“å‰ Promise çš„å¤±è´¥åŸå› ä½œä¸ºå‚æ•°ä¼ å…¥ï¼›</li>
<li>then å‡½æ•°çš„è¿”å›å€¼ä¸º Promiseã€‚</li>
</ul>
<h4 id="promise-çŠ¶æ€">Promise çŠ¶æ€</h4>
<p>Promise çš„ 3 ä¸ªçŠ¶æ€åˆ†åˆ«ä¸º pendingã€fulfilled å’Œ rejectedã€‚</p>
<ul>
<li>pendingï¼šâ€œç­‰å¾…â€çŠ¶æ€ï¼Œå¯ä»¥è½¬ç§»åˆ° fulfilled æˆ–è€… rejected çŠ¶æ€</li>
<li>fulfilledï¼šâ€œæ‰§è¡Œâ€ï¼ˆæˆ–â€œå±¥è¡Œâ€ï¼‰çŠ¶æ€ï¼Œæ˜¯ Promise çš„æœ€ç»ˆæ€ï¼Œè¡¨ç¤ºæ‰§è¡ŒæˆåŠŸï¼Œè¯¥çŠ¶æ€ä¸‹ä¸å¯å†æ”¹å˜ã€‚</li>
<li>rejectedï¼šâ€œæ‹’ç»â€çŠ¶æ€ï¼Œæ˜¯ Promise çš„æœ€ç»ˆæ€ï¼Œè¡¨ç¤ºæ‰§è¡Œå¤±è´¥ï¼Œè¯¥çŠ¶æ€ä¸å¯å†æ”¹å˜ã€‚</li>
</ul>
<h4 id="promise-è§£å†³è¿‡ç¨‹">Promise è§£å†³è¿‡ç¨‹</h4>
<p>Promise è§£å†³è¿‡ç¨‹æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ“ä½œï¼Œå³æ¥æ”¶ä¸€ä¸ª promise å’Œä¸€ä¸ªå€¼ xï¼Œç›®çš„å°±æ˜¯å¯¹ Promise å½¢å¼çš„æ‰§è¡Œç»“æœè¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚éœ€è¦è€ƒè™‘ä»¥ä¸‹ 3 ç§æƒ…å†µã€‚</p>
<h5 id="æƒ…å†µ-1-x-ç­‰äº-promise">æƒ…å†µ 1ï¼š x ç­‰äº promise</h5>
<p>æŠ›å‡ºä¸€ä¸ª TypeError é”™è¯¯ï¼Œæ‹’ç» promiseã€‚</p>
<h5 id="æƒ…å†µ-2x-ä¸º-promise-çš„å®ä¾‹">æƒ…å†µ 2ï¼šx ä¸º Promise çš„å®ä¾‹</h5>
<p>å¦‚æœ x å¤„äºç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆ promise ç»§ç»­ç­‰å¾…è‡³ x æ‰§è¡Œæˆ–æ‹’ç»ï¼Œå¦åˆ™æ ¹æ® x çš„çŠ¶æ€æ‰§è¡Œ/æ‹’ç» promiseã€‚</p>
<h5 id="æƒ…å†µ-3x-ä¸ºå¯¹è±¡æˆ–å‡½æ•°">æƒ…å†µ 3ï¼šx ä¸ºå¯¹è±¡æˆ–å‡½æ•°</h5>
<p>è¯¥æƒ…å†µçš„æ ¸å¿ƒæ˜¯å–å‡º x.then å¹¶è°ƒç”¨ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™å°† this æŒ‡å‘ xã€‚å°† then å›è°ƒå‡½æ•°ä¸­å¾—åˆ°ç»“æœ y ä¼ å…¥æ–°çš„ Promise è§£å†³è¿‡ç¨‹ä¸­ï¼Œå½¢æˆä¸€ä¸ªé€’å½’è°ƒç”¨ã€‚å…¶ä¸­ï¼Œå¦‚æœæ‰§è¡ŒæŠ¥é”™ï¼Œåˆ™ä»¥å¯¹åº”çš„é”™è¯¯ä¸ºåŸå› æ‹’ç» promiseã€‚</p>
<p>è¿™ä¸€æ­¥æ˜¯å¤„ç†æ‹¥æœ‰ then() å‡½æ•°çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œè¿™ç±»å¯¹è±¡æˆ–å‡½æ•°æˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œthenableâ€ã€‚æ³¨æ„ï¼Œå®ƒåªæ˜¯æ‹¥æœ‰ then() å‡½æ•°ï¼Œå¹¶ä¸æ˜¯ Promise å®ä¾‹ã€‚</p>
<h5 id="æƒ…å†µ-4å¦‚æœ-x-ä¸ä¸ºå¯¹è±¡æˆ–å‡½æ•°">æƒ…å†µ 4ï¼šå¦‚æœ x ä¸ä¸ºå¯¹è±¡æˆ–å‡½æ•°</h5>
<p>ä»¥ x ä½œä¸ºå€¼ï¼Œæ‰§è¡Œ promise</p>
<h3 id="2-promise-å®ç°">2. Promise å®ç°</h3>
<p>ä¸‹é¢æˆ‘ä»¬å°±æ ¹æ®è§„èŒƒæ¥é€æ­¥å®ç°ä¸€ä¸ª Promiseã€‚</p>
<h4 id="promise-å‡½æ•°åŠçŠ¶æ€">Promise() å‡½æ•°åŠçŠ¶æ€</h4>
<p>ç”±äº Promise åªæœ‰ 3 ä¸ª çŠ¶æ€ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å…ˆåˆ›å»º 3 ä¸ªâ€œå¸¸é‡â€æ¥æ¶ˆé™¤é­”æœ¯å­—ç¬¦ä¸²ï¼š</p>
<pre><code class="language-javascript">const PENDING = 'pending';
const FULFILLED = 'fulfulled';
const REJECTED = 'rejected';
</code></pre>
<p>ç”±äº Promise å¯ä»¥è¢«å®ä¾‹åŒ–ï¼Œæ‰€ä»¥å¯ä»¥å®šä¹‰æˆç±»æˆ–å‡½æ•°ï¼Œè¿™é‡Œä¸ºäº†å¢åŠ éš¾åº¦ï¼Œå…ˆè€ƒè™‘åœ¨ ES5 ç¯å¢ƒä¸‹å®ç°ï¼Œæ‰€ä»¥å†™æˆæ„é€ å‡½æ•°çš„å½¢å¼ã€‚</p>
<p>ä½¿ç”¨è¿‡ Promise çš„äººè‚¯å®šçŸ¥é“ï¼Œåœ¨åˆ›å»º Promise çš„æ—¶å€™ä¼šä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ç”¨æ¥æ‰§è¡Œæˆ–æ‹’ç»å½“å‰ Promiseã€‚åŒæ—¶è€ƒè™‘åˆ° Promise åœ¨æ‰§è¡Œæ—¶å¯èƒ½ä¼šæœ‰è¿”å›å€¼ï¼Œåœ¨æ‹’ç»æ—¶ä¼šç»™å‡ºæ‹’ç»åŸå› ï¼Œæˆ‘ä»¬åˆ†åˆ«ç”¨ value å’Œ reason ä¸¤ä¸ªå˜é‡æ¥è¡¨ç¤ºã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">functionÂ Promise(execute)Â {

Â Â constÂ selfÂ =Â this;

Â Â self.stateÂ =Â PENDING;

Â Â functionÂ resolve(value)Â {
Â Â Â Â ifÂ (self.stateÂ ===Â PENDING)Â {
Â Â Â Â Â Â self.stateÂ =Â FULFILLED;
Â Â Â Â Â Â self.valueÂ =Â value;
Â Â Â Â }
Â Â }

Â Â functionÂ reject(reason)Â {
Â Â Â Â ifÂ (self.stateÂ ===Â PENDING)Â {
Â Â Â Â Â Â self.stateÂ =Â REJECTED;
Â Â Â Â Â Â self.reasonÂ =Â reason;
Â Â Â Â }
Â Â }
Â Â 
Â Â tryÂ {
Â Â Â Â execute(resolve,Â reject);
Â Â }Â catchÂ (e)Â {
Â Â Â Â reject(e);
Â Â }
}
</code></pre>
<p>Promise æ˜¯å•æ¬¡æ‰§è¡Œçš„ï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­çŠ¶æ€ä¸º PENDING çš„æ—¶å€™å†æ‰§è¡Œå‡½æ•° resolve() æˆ–å‡½æ•° reject() ã€‚åŒæ—¶ Promise çš„å†…éƒ¨å¼‚å¸¸ä¸èƒ½ç›´æ¥æŠ›å‡ºï¼Œæ‰€ä»¥è¦è¿›è¡Œå¼‚å¸¸æ•è·ã€‚</p>
<h4 id="then-å‡½æ•°-2">then() å‡½æ•°</h4>
<p>æ¯ä¸ª Promise å®ä¾‹éƒ½æœ‰ä¸€ä¸ª then() å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè®¿é—® Promise å†…éƒ¨çš„å€¼æˆ–æ‹’ç»åŸå› ï¼Œæ‰€ä»¥é€šè¿‡å‡½æ•°åŸå‹ prototype æ¥å®ç°ã€‚then() å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œäºæ˜¯å†™æˆä¸‹é¢çš„å½¢å¼ï¼š</p>
<pre><code class="language-javascript">Promise.prototype.then = function (onFulfilled, onRejected) {

}
</code></pre>
<p>æ ¹æ®ç¬¬ 1 æ¡åŸåˆ™ï¼Œå¦‚æœå¯é€‰å‚æ•°ä¸ä¸ºå‡½æ•°æ—¶åº”è¯¥è¢«å¿½ç•¥ï¼Œæ‰€ä»¥åœ¨å‡½æ•° then() å†…éƒ¨åŠ ä¸Šå¯¹å‚æ•°çš„åˆ¤æ–­ï¼š</p>
<pre><code class="language-javascript">onFulfilled = typeof onFulfilled === &quot;function&quot; ? onFulfilled : function (x) {
Â  return x
};

onRejected = typeof onRejected === &quot;function&quot; ? onRejected : function (e) {
Â  throw e
};
</code></pre>
<p>æ ¹æ®ç¬¬ 2 æ¡è§„åˆ™ï¼Œä¼ å…¥çš„å›è°ƒå‡½æ•°æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚è¦æ¨¡æ‹Ÿå¼‚æ­¥ï¼Œå¯ä»¥é€šè¿‡ setTimeout æ¥å»¶è¿Ÿæ‰§è¡Œã€‚å†æ ¹æ®ç¬¬ 3 æ¡å’Œç¬¬ 4 æ¡è§„åˆ™ï¼Œåº”æ ¹æ® Promise çš„çŠ¶æ€æ¥æ‰§è¡Œå¯¹åº”çš„å›è°ƒï¼Œæ‰§è¡ŒçŠ¶æ€ä¸‹è°ƒç”¨ onFulfilled() å‡½æ•°ï¼Œæ‹’ç»çŠ¶æ€ä¸‹è°ƒç”¨ onRejected() å‡½æ•°ã€‚</p>
<pre><code class="language-javascript">let self = this;

switch (self.state) {
Â  case FULFILLED:
Â  Â  setTimeout(function () {
Â  Â  Â  onFulfilled(self.value);
Â  Â  })
Â  Â  break;

Â  case REJECTED:
Â  Â  setTimeout(function () {
Â  Â  Â  onRejected(self.reason);
Â  Â  })
Â  Â  break;
Â  Â  
Â  case PENDING:
    // todo
Â  Â  break;
}
</code></pre>
<p>ç­‰å¾…çŠ¶æ€ä¸‹å°±æœ‰äº›éº»çƒ¦äº†ï¼Œéœ€è¦ç­‰åˆ° Promise çŠ¶æ€è½¬å˜æ—¶æ‰èƒ½è°ƒç”¨ã€‚</p>
<p>æŒ‰ç…§å¸¸è§„å¤„ç†æ–¹å¼ï¼Œå¯ä»¥å»ºç«‹ä¸€ä¸ªç›‘å¬ï¼Œç›‘å¬ Promise çš„çŠ¶æ€å€¼æ”¹å˜ã€‚ç”±äºæµè§ˆå™¨ç¯å¢ƒå’Œ Node.js ç¯å¢ƒçš„äº‹ä»¶ç›‘å¬ä¸ä¸€æ ·ï¼Œè€ƒè™‘å…¼å®¹æ€§ï¼Œè¿™ç§å®ç°ä¼šæ¯”è¾ƒå¤æ‚ã€‚</p>
<p>æ¢ä¸ªè§’åº¦æ¥çœ‹ï¼Œåœ¨ä¸è€ƒè™‘å¼‚å¸¸çš„æƒ…å†µä¸‹ Promise çš„çŠ¶æ€æ”¹å˜åªä¾èµ–äºæ„é€ å‡½æ•°ä¸­çš„ resolve() å‡½æ•°å’Œ reject() å‡½æ•°æ‰§è¡Œã€‚æ‰€ä»¥å¯è€ƒè™‘å°† onFulfilled() å’Œ onRejected() å‡½æ•°å…ˆä¿å­˜åˆ° Promise å±æ€§ onFulfilledFn å’Œ onRejectedFn ä¸­ï¼Œç­‰åˆ°çŠ¶æ€æ”¹å˜æ—¶å†è°ƒç”¨ã€‚</p>
<pre><code class="language-javascript">case PENDING:
Â  self.onFulfilledFn = function () {
Â  Â  onFulfilled(self.value);
  }
Â  self.onRejectedFn = function () {
Â  Â  onRejected(self.reason);
Â  }
  break;
</code></pre>
<p>æœ€åçœ‹ç¬¬ 5 æ¡è§„åˆ™ï¼Œthen() è¢«è°ƒç”¨æ—¶åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œæ‰€ä»¥åœ¨ä¸Šé¢çš„ 3 ç§çŠ¶æ€çš„å¤„ç†é€»è¾‘ä¸­ï¼Œéƒ½åº”è¯¥åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª Promise å®ä¾‹ã€‚ä»¥æ‰§è¡ŒçŠ¶æ€ä¸ºä¾‹ï¼Œå¯ä»¥æ”¹æˆä¸‹é¢çš„æ ·å­ã€‚</p>
<pre><code class="language-javascript">case FULFILLED:

Â  promise = new Promise(function (resolve, reject) {
Â  Â  setTimeout(function () {
Â  Â  Â  try {
Â  Â  Â  Â  onFulfilled(self.value);
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  reject(e)
Â  Â  Â  }
Â  Â  })
Â  });
Â  break;
</code></pre>
<p>åŒæ—¶ï¼Œå®ƒå¸¦æ¥çš„å¦ä¸€ä¸ªæ•ˆæœæ˜¯æ”¯æŒé“¾å¼è°ƒç”¨ã€‚åœ¨é“¾å¼è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œå¦‚æœ Promise å®ä¾‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆéœ€è¦ä¿å­˜å¤šä¸ª resolve() æˆ– reject() å‡½æ•°ï¼Œæ‰€ä»¥ onFulfilledFn å’Œ onRejectedFn åº”è¯¥æ”¹æˆæ•°ç»„ã€‚</p>
<pre><code class="language-javascript">case PENDING:

Â  promise = new Promise(function (resolve, reject) {
Â  Â  self.onFulfilledFn.push(function () {
Â  Â  Â  try {
Â  Â  Â  Â  onFulfilled(self.value);
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  reject(e)
Â  Â  Â  }
Â  Â  });

Â  Â  self.onRejectedFn.push(function () {
Â  Â  Â  try {
Â  Â  Â  Â  onRejected(self.reason);
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  reject(e)
Â  Â  Â  }
Â  Â  })
Â  });
Â  break;
</code></pre>
<p>å¯¹åº”çš„ï¼ŒPromise æ„é€ å‡½æ•°ä¸­åº”è¯¥åˆå§‹åŒ–å±æ€§ onFulfilledFn å’Œ onRejectedFn ä¸ºæ•°ç»„ï¼ŒåŒæ—¶ resolve() å’Œ reject() å‡½æ•°åœ¨æ”¹å˜çŠ¶æ€æ—¶åº”è¯¥è°ƒç”¨è¿™ä¸ªæ•°ç»„ä¸­çš„å‡½æ•°ï¼Œå¹¶ä¸”è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹åº”è¯¥æ˜¯å¼‚æ­¥çš„ã€‚</p>
<pre><code>function Promise(execute) {
  ...
Â  self.onFulfilledFn = [];
Â  self.onRejectedFn = [];

  ...
  function resolve(value) {
    setTimeout(function() {
      ...
  Â  Â  self.onFulfilledFn.forEach(function (f) {
Â    Â  Â  f(self.value)
  Â  Â  })
    })
Â  }

  function reject(reason) {
    setTimeout(function() {
      ...
  Â  Â  self.onRejectedFn.forEach(function (f) {
  Â  Â  Â  f(self.reason)
  Â  Â  })
    })
Â  }
}
</code></pre>
<h4 id="resolvepromise-å‡½æ•°">resolvePromise() å‡½æ•°</h4>
<p>å‰é¢æåˆ°è§£å†³è¿‡ç¨‹å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°åŠ 3 ç§æƒ…å†µï¼Œå…ˆæ¥è€ƒè™‘ç¬¬ 1 ç§æƒ…å†µï¼Œpromise ä¸ x ç›¸ç­‰ï¼Œåº”è¯¥ç›´æ¥æŠ›å‡º TypeError é”™è¯¯ï¼š</p>
<pre><code class="language-javascript">function resolvePromise(promise, x) {
  if (promise === x) {
Â  Â  return reject(new TypeError(&quot;x ä¸èƒ½ä¸ promise ç›¸ç­‰&quot;));
Â  }
}
</code></pre>
<p>æƒ…å†µ 2ï¼Œx ä¸º Promise çš„å®ä¾‹ï¼Œåº”è¯¥å°è¯•è®© promise æ¥å— x çš„çŠ¶æ€ï¼Œæ€ä¹ˆæ¥å—å‘¢ï¼Ÿ</p>
<p>ç›´æ¥æ”¹å˜ promise çŠ¶æ€è‚¯å®šæ˜¯ä¸å¯å–çš„ï¼Œé¦–å…ˆçŠ¶æ€ä¿¡æ¯å±äºå†…éƒ¨å˜é‡ï¼Œå…¶æ¬¡ä¹Ÿæ— æ³•è°ƒç”¨å±æ€§ onResolvedFn å’Œ onFulfilledFn ä¸­çš„å¾…æ‰§è¡Œå‡½æ•°ã€‚æ‰€ä»¥å¿…é¡»è¦é€šè¿‡è°ƒç”¨ promise åœ¨æ„é€ æ—¶çš„å‡½æ•° resolve() å’Œ reject() æ¥æ”¹å˜ã€‚</p>
<p>å¦‚æœ x å¤„äºç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆ promise ç»§ç»­ä¿æŒç­‰å¾…çŠ¶æ€ï¼Œç­‰å¾…è§£å†³è¿‡ç¨‹å‡½æ•° resolvePromise() æ‰§è¡Œï¼Œå¦åˆ™åº”è¯¥ç”¨ç›¸åŒçš„å€¼æ‰§è¡Œæˆ–æ‹’ç» promiseã€‚æˆ‘ä»¬æ— æ³•ä»å¤–éƒ¨æ‹’ç»æˆ–æ‰§è¡Œä¸€ä¸ª Promise å®ä¾‹ï¼Œåªèƒ½é€šè¿‡è°ƒç”¨æ„é€ å‡½æ•°ä¼ å…¥çš„ resolve() å’Œ reject() å‡½æ•°æ¥å®ç°ã€‚æ‰€ä»¥è¿˜éœ€è¦æŠŠè¿™ä¸¤ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’åˆ° resolvePromise å‡½æ•°ä¸­ã€‚</p>
<p>åœ¨å‡½æ•° resolvePromise() å†…éƒ¨åŠ ä¸Šæƒ…å†µ 2 çš„åˆ¤æ–­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">function resolvePromise(promise, x, resolve, reject) {
  ...
  if (x instanceof Promise) {
Â  Â  if (x.state === FULFILLED) {
Â  Â  Â  resolve(x.value)
Â  Â  } else if (x.state === REJECTED) {
Â  Â  Â  reject(x.reason)
Â  Â  } else {
Â  Â  Â  x.then(function (y) {
Â  Â  Â  Â  resolvePromise(promise, y, resolve, reject)
Â  Â  Â  }, reject)
Â  Â  }
Â  }
}
</code></pre>
<p>å†æ¥å®ç°æƒ…å†µ 3ï¼Œå°† x.then å–å‡ºç„¶åæ‰§è¡Œï¼Œå¹¶å°†æ‰§è¡Œç»“æœæ”¾å…¥è§£å†³è¿‡ç¨‹å‡½æ•° resolvePromise() ä¸­ã€‚ è€ƒè™‘åˆ° x å¯èƒ½åªæ˜¯ä¸€ä¸ª thenable è€ŒéçœŸæ­£çš„ Promiseï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ then() å‡½æ•°çš„æ—¶å€™è¦è®¾ç½®ä¸€ä¸ªå˜é‡ excuted é¿å…é‡å¤è°ƒç”¨ã€‚åŒæ—¶è®°å¾—åœ¨æ‰§è¡Œæ—¶æ·»åŠ å¼‚å¸¸æ•è·å¹¶åŠæ—¶æ‹’ç»å½“å‰ promiseã€‚</p>
<pre><code class="language-javascript">if ((x !== null) &amp;&amp; ((typeof x === 'object') || (typeof x === 'function'))) {
Â  let executed;
Â  try {
Â  Â  let then = x.then;
Â  Â  if (typeof then === &quot;function&quot;) {
Â  Â  Â  then.call(x, function (y) {
Â  Â  Â  Â  if (executed) return;
Â  Â  Â  Â  executed = true;
Â  Â  Â  Â  return resolvePromise(promise, y, resolve, reject)
Â  Â  Â  }, function (e) {
Â  Â  Â  Â  if (executed) return;
Â  Â  Â  Â  executed = true;
Â  Â  Â  Â  reject(e);
Â  Â  Â  })
Â  Â  } else {
Â  Â  Â  resolve(x);
Â  Â  }
Â  } catch (e) {
Â  Â  if (executed) return;
Â  Â  executed = true;
Â  Â  reject(e);
Â  }
}
</code></pre>
<p>æƒ…å†µ 4 å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥æŠŠ x ä½œä¸ºå€¼æ‰§è¡Œã€‚</p>
<pre><code class="language-javascript">resolve(x);
</code></pre>
<h3 id="3-promise-æµ‹è¯•">3. Promise æµ‹è¯•</h3>
<p>ç¼–å†™æµ‹è¯•ä»£ç æ°¸è¿œæ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œä¸ºäº†éªŒè¯ç¼–å†™çš„ Promise æ­£ç¡®æ€§ï¼Œå¼•ç”¨ä¸€ä¸ªä¸“é—¨ç”¨æ¥æµ‹è¯• Promise è§„èŒƒæ€§çš„æ¨¡å— promises-aplus-testsï¼Œè¯¥æ¨¡å—å†…ç½®äº†æ•°ç™¾ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œæ”¯æŒå‘½ä»¤è¡Œä¸€é”®æµ‹è¯•ã€‚åªæ˜¯åœ¨å¯¼å‡ºæ¨¡å—çš„æ—¶å€™éœ€è¦éµå¾ª CommonJS è§„èŒƒï¼Œå¹¶ä¸”æŒ‰ç…§è¦æ±‚å¯¼å‡ºå¯¹åº”çš„å‡½æ•°ã€‚<a href="https://github.com/wendy-banzhuanke/data-structure/tree/master/src/promise">æœ€ç»ˆä»£ç åœ°å€è¯·ç‚¹å‡»è¿™é‡Œè·å–</a>ã€‚</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#1-promisea-%E8%A7%84%E8%8C%83">1. Promise/A+ è§„èŒƒ</a>
<ul>
<li><a href="#then-%E5%87%BD%E6%95%B0">then å‡½æ•°</a></li>
<li><a href="#promise-%E7%8A%B6%E6%80%81">Promise çŠ¶æ€</a></li>
<li><a href="#promise-%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B">Promise è§£å†³è¿‡ç¨‹</a>
<ul>
<li><a href="#%E6%83%85%E5%86%B5-1-x-%E7%AD%89%E4%BA%8E-promise">æƒ…å†µ 1ï¼š x ç­‰äº promise</a></li>
<li><a href="#%E6%83%85%E5%86%B5-2x-%E4%B8%BA-promise-%E7%9A%84%E5%AE%9E%E4%BE%8B">æƒ…å†µ 2ï¼šx ä¸º Promise çš„å®ä¾‹</a></li>
<li><a href="#%E6%83%85%E5%86%B5-3x-%E4%B8%BA%E5%AF%B9%E8%B1%A1%E6%88%96%E5%87%BD%E6%95%B0">æƒ…å†µ 3ï¼šx ä¸ºå¯¹è±¡æˆ–å‡½æ•°</a></li>
<li><a href="#%E6%83%85%E5%86%B5-4%E5%A6%82%E6%9E%9C-x-%E4%B8%8D%E4%B8%BA%E5%AF%B9%E8%B1%A1%E6%88%96%E5%87%BD%E6%95%B0">æƒ…å†µ 4ï¼šå¦‚æœ x ä¸ä¸ºå¯¹è±¡æˆ–å‡½æ•°</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-promise-%E5%AE%9E%E7%8E%B0">2. Promise å®ç°</a>
<ul>
<li><a href="#promise-%E5%87%BD%E6%95%B0%E5%8F%8A%E7%8A%B6%E6%80%81">Promise() å‡½æ•°åŠçŠ¶æ€</a></li>
<li><a href="#then-%E5%87%BD%E6%95%B0-2">then() å‡½æ•°</a></li>
<li><a href="#resolvepromise-%E5%87%BD%E6%95%B0">resolvePromise() å‡½æ•°</a></li>
</ul>
</li>
<li><a href="#3-promise-%E6%B5%8B%E8%AF%95">3. Promise æµ‹è¯•</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://wendy-banzhuanke.github.io/js-file-prototype/">
              <h3 class="post-title">
                JS ä¹‹ åŸå‹è¯¦è§£
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  å¦‚æœå‹¤å¿«åƒæ‡’ä¸€æ ·é‚£ä¹ˆå®¹æ˜“å°±èƒ½åšåˆ°ï¼ŒçŒªéƒ½èƒ½ä¸Šå¤©äº†~~~ï¼ˆå¹¶æ²¡æœ‰è´¬ä½ğŸ·çš„æ„æ€ï¼‰
  <a class="rss" href="https://wendy-banzhuanke.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
